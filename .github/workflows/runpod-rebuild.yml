name: Rebuild RunPod Endpoint

on:
  push:
    branches:
      - main
    paths:
      - 'runpod_worker/**'
      - '.github/workflows/runpod-rebuild.yml'
  release:
    types: [published, edited]
  workflow_dispatch:  # Permet de déclencher manuellement depuis l'interface GitHub

jobs:
  rebuild-runpod:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Trigger RunPod Endpoint Rebuild
        env:
          RUNPOD_API_KEY: ${{ secrets.RUNPOD_API_KEY }}
          RUNPOD_ENDPOINT_ID: ${{ secrets.RUNPOD_ENDPOINT_ID }}
        run: |
          echo "Déclenchement du rebuild de l'endpoint RunPod..."
          
          # Vérifier que les secrets sont configurés
          if [ -z "$RUNPOD_API_KEY" ] || [ -z "$RUNPOD_ENDPOINT_ID" ]; then
            echo "❌ Erreur: RUNPOD_API_KEY ou RUNPOD_ENDPOINT_ID manquant dans les secrets GitHub"
            exit 1
          fi
          
          # Méthode 1: Utiliser l'API REST RunPod (plus simple et fiable)
          # PATCH /v1/endpoints/{endpointId} déclenche un rolling release
          echo "Tentative avec l'API REST..."
          rest_response=$(curl -s -w "\n%{http_code}" -X PATCH \
            "https://rest.runpod.io/v1/endpoints/${RUNPOD_ENDPOINT_ID}" \
            -H "Authorization: Bearer ${RUNPOD_API_KEY}" \
            -H "Content-Type: application/json" \
            -d '{}')
          
          rest_http_code=$(echo "$rest_response" | tail -n1)
          rest_body=$(echo "$rest_response" | sed '$d')
          
          if [ "$rest_http_code" -eq 200 ] || [ "$rest_http_code" -eq 201 ]; then
            echo "✅ Rebuild déclenché avec succès via REST API!"
            echo "Réponse: $rest_body"
          else
            echo "⚠️ REST API a échoué (HTTP $rest_http_code), tentative avec GraphQL..."
            echo "Réponse REST: $rest_body"
            
            # Méthode 2: Fallback sur GraphQL - récupérer d'abord les infos de l'endpoint
            echo "Récupération des informations de l'endpoint..."
            endpoint_info=$(curl -s -X POST \
              "https://api.runpod.io/graphql?api_key=${RUNPOD_API_KEY}" \
              -H "Content-Type: application/json" \
              -d "{\"query\": \"query { endpoint(id: \\\"${RUNPOD_ENDPOINT_ID}\\\") { id name templateId gpuIds workersMin workersMax } }\"}")
            
            # Extraire les valeurs nécessaires (simplifié - on utilise juste l'ID et le templateId)
            # Pour forcer un rebuild, on met à jour avec les mêmes paramètres
            template_id=$(echo "$endpoint_info" | grep -o '"templateId":"[^"]*"' | cut -d'"' -f4 || echo "")
            endpoint_name=$(echo "$endpoint_info" | grep -o '"name":"[^"]*"' | cut -d'"' -f4 || echo "aodio-endpoint")
            
            if [ -z "$template_id" ]; then
              echo "❌ Impossible de récupérer le templateId de l'endpoint"
              echo "Réponse GraphQL: $endpoint_info"
              exit 1
            fi
            
            echo "Utilisation du templateId: $template_id"
            
            # Mettre à jour l'endpoint avec les mêmes paramètres pour forcer un rebuild
            graphql_response=$(curl -s -w "\n%{http_code}" -X POST \
              "https://api.runpod.io/graphql?api_key=${RUNPOD_API_KEY}" \
              -H "Content-Type: application/json" \
              -d "{\"query\": \"mutation { saveEndpoint(input: { id: \\\"${RUNPOD_ENDPOINT_ID}\\\", name: \\\"${endpoint_name}\\\", templateId: \\\"${template_id}\\\" }) { id name templateId } }\"}")
            
            graphql_http_code=$(echo "$graphql_response" | tail -n1)
            graphql_body=$(echo "$graphql_response" | sed '$d')
            
            if [ "$graphql_http_code" -eq 200 ] && ! echo "$graphql_body" | grep -q '"errors"'; then
              echo "✅ Rebuild déclenché avec succès via GraphQL!"
              echo "Réponse: $graphql_body"
            else
              echo "❌ Erreur GraphQL (HTTP $graphql_http_code)"
              echo "Réponse: $graphql_body"
              exit 1
            fi
          fi

      - name: Wait for deployment
        if: success()
        run: |
          echo "⏳ Attente de 10 secondes pour laisser le déploiement démarrer..."
          sleep 10
          echo "✅ Le rebuild a été déclenché. Vérifiez le statut sur RunPod."

