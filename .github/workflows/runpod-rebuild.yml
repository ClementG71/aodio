name: Rebuild RunPod Endpoint

on:
  push:
    branches:
      - main
    paths:
      - 'runpod_worker/**'
      - '.github/workflows/runpod-rebuild.yml'
  release:
    types: [published, edited]
  workflow_dispatch:  # Permet de déclencher manuellement depuis l'interface GitHub

jobs:
  rebuild-runpod:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Trigger RunPod Endpoint Rebuild
        env:
          RUNPOD_API_KEY: ${{ secrets.RUNPOD_API_KEY }}
          RUNPOD_ENDPOINT_ID: ${{ secrets.RUNPOD_ENDPOINT_ID }}
        run: |
          echo "Déclenchement du rebuild de l'endpoint RunPod..."
          
          # Vérifier que les secrets sont configurés
          if [ -z "$RUNPOD_API_KEY" ] || [ -z "$RUNPOD_ENDPOINT_ID" ]; then
            echo "❌ Erreur: RUNPOD_API_KEY ou RUNPOD_ENDPOINT_ID manquant dans les secrets GitHub"
            exit 1
          fi
          
          # Pour déclencher un rebuild, on doit récupérer les infos de l'endpoint
          # et les renvoyer pour forcer une mise à jour (rolling release)
          echo "Récupération des informations de l'endpoint..."
          
          # Récupérer les infos via GraphQL
          endpoint_query=$(curl -s -X POST \
            "https://api.runpod.io/graphql?api_key=${RUNPOD_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{\"query\": \"query { endpoint(id: \\\"${RUNPOD_ENDPOINT_ID}\\\") { id name templateId gpuIds workersMin workersMax scalerType scalerValue idleTimeout } }\"}")
          
          echo "Réponse GraphQL (infos endpoint): $endpoint_query"
          
          # Extraire les valeurs nécessaires
          template_id=$(echo "$endpoint_query" | grep -o '"templateId":"[^"]*"' | cut -d'"' -f4 || echo "")
          endpoint_name=$(echo "$endpoint_query" | grep -o '"name":"[^"]*"' | cut -d'"' -f4 || echo "aodio-endpoint")
          gpu_ids=$(echo "$endpoint_query" | grep -o '"gpuIds":"[^"]*"' | cut -d'"' -f4 || echo "")
          workers_min=$(echo "$endpoint_query" | grep -o '"workersMin":[0-9]*' | cut -d':' -f2 || echo "0")
          workers_max=$(echo "$endpoint_query" | grep -o '"workersMax":[0-9]*' | cut -d':' -f2 || echo "1")
          
          if [ -z "$template_id" ]; then
            echo "❌ Impossible de récupérer le templateId de l'endpoint"
            echo "Réponse GraphQL: $endpoint_query"
            exit 1
          fi
          
          echo "Endpoint: $endpoint_name"
          echo "Template ID: $template_id"
          echo "Workers: min=$workers_min, max=$workers_max"
          
          # Méthode 1: Utiliser GraphQL pour mettre à jour avec les mêmes paramètres
          # Cela déclenche un rolling release qui rebuild l'endpoint
          echo "Mise à jour de l'endpoint via GraphQL pour déclencher le rebuild..."
          graphql_response=$(curl -s -w "\n%{http_code}" -X POST \
            "https://api.runpod.io/graphql?api_key=${RUNPOD_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{\"query\": \"mutation { saveEndpoint(input: { id: \\\"${RUNPOD_ENDPOINT_ID}\\\", name: \\\"${endpoint_name}\\\", templateId: \\\"${template_id}\\\", gpuIds: \\\"${gpu_ids}\\\", workersMin: ${workers_min}, workersMax: ${workers_max} }) { id name templateId } }\"}")
          
          graphql_http_code=$(echo "$graphql_response" | tail -n1)
          graphql_body=$(echo "$graphql_response" | sed '$d')
          
          if [ "$graphql_http_code" -eq 200 ] && ! echo "$graphql_body" | grep -q '"errors"'; then
            echo "✅ Rebuild déclenché avec succès via GraphQL!"
            echo "Réponse: $graphql_body"
          else
            echo "⚠️ GraphQL a échoué, tentative avec REST API..."
            echo "Réponse GraphQL: $graphql_body"
            
            # Méthode 2: Fallback sur REST API avec les paramètres récupérés
            rest_response=$(curl -s -w "\n%{http_code}" -X PATCH \
              "https://rest.runpod.io/v1/endpoints/${RUNPOD_ENDPOINT_ID}" \
              -H "Authorization: Bearer ${RUNPOD_API_KEY}" \
              -H "Content-Type: application/json" \
              -d "{\"templateId\": \"${template_id}\", \"workersMin\": ${workers_min}, \"workersMax\": ${workers_max}}")
            
            rest_http_code=$(echo "$rest_response" | tail -n1)
            rest_body=$(echo "$rest_response" | sed '$d')
            
            if [ "$rest_http_code" -eq 200 ] || [ "$rest_http_code" -eq 201 ]; then
              echo "✅ Rebuild déclenché avec succès via REST API!"
              echo "Réponse: $rest_body"
            else
              echo "❌ Erreur REST API (HTTP $rest_http_code)"
              echo "Réponse: $rest_body"
              exit 1
            fi
          fi

      - name: Wait for deployment
        if: success()
        run: |
          echo "⏳ Attente de 10 secondes pour laisser le déploiement démarrer..."
          sleep 10
          echo "✅ Le rebuild a été déclenché. Vérifiez le statut sur RunPod."

