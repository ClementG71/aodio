name: Rebuild RunPod Endpoint

on:
  push:
    branches:
      - main
    paths:
      - 'runpod_worker/**'
      - '.github/workflows/runpod-rebuild.yml'
  release:
    types: [published, edited]
  workflow_dispatch:  # Permet de déclencher manuellement depuis l'interface GitHub

jobs:
  rebuild-runpod:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Trigger RunPod Endpoint Rebuild
        env:
          RUNPOD_API_KEY: ${{ secrets.RUNPOD_API_KEY }}
          RUNPOD_ENDPOINT_ID: ${{ secrets.RUNPOD_ENDPOINT_ID }}
        run: |
          echo "Déclenchement du rebuild de l'endpoint RunPod..."
          
          # Vérifier que les secrets sont configurés
          if [ -z "$RUNPOD_API_KEY" ] || [ -z "$RUNPOD_ENDPOINT_ID" ]; then
            echo "❌ Erreur: RUNPOD_API_KEY ou RUNPOD_ENDPOINT_ID manquant dans les secrets GitHub"
            exit 1
          fi
          
          # Méthode 1: Utiliser l'API GraphQL RunPod (plus fiable selon la doc)
          # La mutation saveEndpoint avec forceUpdateTemplate déclenche un rebuild
          echo "Tentative avec l'API GraphQL..."
          graphql_response=$(curl -s -w "\n%{http_code}" -X POST \
            "https://api.runpod.io/graphql?api_key=${RUNPOD_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{\"query\": \"mutation { saveEndpoint(input: { id: \\\"${RUNPOD_ENDPOINT_ID}\\\", forceUpdateTemplate: true }) { id } }\"}")
          
          graphql_http_code=$(echo "$graphql_response" | tail -n1)
          graphql_body=$(echo "$graphql_response" | sed '$d')
          
          if [ "$graphql_http_code" -eq 200 ]; then
            # Vérifier si la réponse GraphQL contient des erreurs
            if echo "$graphql_body" | grep -q '"errors"'; then
              echo "⚠️ GraphQL a retourné des erreurs, tentative avec REST API..."
              # Méthode 2: Fallback sur REST API
              rest_response=$(curl -s -w "\n%{http_code}" -X PATCH \
                "https://rest.runpod.io/v1/endpoints/${RUNPOD_ENDPOINT_ID}" \
                -H "Authorization: Bearer ${RUNPOD_API_KEY}" \
                -H "Content-Type: application/json" \
                -d '{"forceUpdateTemplate": true}')
              
              rest_http_code=$(echo "$rest_response" | tail -n1)
              rest_body=$(echo "$rest_response" | sed '$d')
              
              if [ "$rest_http_code" -eq 200 ] || [ "$rest_http_code" -eq 201 ]; then
                echo "✅ Rebuild déclenché avec succès via REST API!"
                echo "Réponse: $rest_body"
              else
                echo "❌ Erreur REST API (HTTP $rest_http_code)"
                echo "Réponse: $rest_body"
                echo "Réponse GraphQL: $graphql_body"
                exit 1
              fi
            else
              echo "✅ Rebuild déclenché avec succès via GraphQL!"
              echo "Réponse: $graphql_body"
            fi
          else
            echo "❌ Erreur GraphQL (HTTP $graphql_http_code)"
            echo "Réponse: $graphql_body"
            exit 1
          fi

      - name: Wait for deployment
        if: success()
        run: |
          echo "⏳ Attente de 10 secondes pour laisser le déploiement démarrer..."
          sleep 10
          echo "✅ Le rebuild a été déclenché. Vérifiez le statut sur RunPod."

